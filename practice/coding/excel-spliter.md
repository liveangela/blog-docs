---
description: 2022.03.19
---

# Excel高级拆表

## 背景

银行工作中经常需要对一张表的多个sheet，按某行归类后拆分成多个表，拆分后的表需要满足以下需求：

1. 和主表保持一样的sheet数量和名称
2. 仅包含某一个行归类后的所有数据，不能有其他行归类的数据

人工进行拆分可能需要120次同样的重复动作，非常没有效率

## 产品限制

由于银行工作的保密要求，是不能将excel文件上传或者分享的，因此产品形态大概是以下几种之一：

1. vba代码段，导入目标excel后执行
2. js代码+bat命令
3. 应用程序

## 程序设计

### 方案一

* 读取主文件内所有sheet内容到内存，得到多个sheet，每个sheet中有多行多列
* 按指定列名中的多个行进行归类（group by），得到归类后的unique名单，作为拆分依据
* 在内存中按每个类，对每个sheet数据进行提取，提出后写入到归类名称的文件中
* 直到所有unique名单中的项完成

### 方案二

方案一是保证了一个子文件一次性写入多个sheet表，但缺点是需要一次性读取所有的主内容到内存，可能对电脑内存要求较大，改用一次仅读取一个sheet内容的方式

* 读取主文件第一个sheet的所有内容
* 按指定列进行归类，归类名称存入map对象
* 按map对象中的每个归类，分别新建并写入到相应类名的文件的对应sheet中
* 再读取主文件的第二个sheet的所有内容
* 再对指定列进行一次归类（因为不同sheet的归类结果可能不同），map对象增量添加新的归类名称
* 按map对象中的每个归类，已有同名文件则写入第二个sheet中，没有文件则新建，且第一个sheet需维持一张同名空表
* 直到主表所有sheet遍历完成

统一化的逻辑就是：

* 获取主表中有内容的sheet总数量，以及sheet名称
* 循环遍历每个sheet，group by指定列，并将group名称存入全局维持的map对象
* 按group名称拿取本次循环中sheet内容，没有则为指定空白提示文案
* 写入group名称对应文件，没有则新建
* 当非首次循环还出现新建行为，需要补齐前面所有sheet（维持名称）
